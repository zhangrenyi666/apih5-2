<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <title>选择部门列表</title>
    <meta name="keywords" content="多级下拉菜单, jquery插件" />
    <meta name="description" content="选择部门" />
    <!--<link rel="stylesheet" type="text/css" href="../css/main.css" />-->
    <link rel="stylesheet" type="text/css" href="../css/selectDepartment.css" />
    <script type="text/javascript" src="../lib/jquery/1.9.1/jquery.js"></script>
    <script type="text/javascript" src="../lib/multi_menu/accordion.js"></script>
    <script type="text/javascript" src="../lib/action-sheet/action-sheet.js"></script>
    <script type="text/javascript" src="../lib/layer_mobile/layer.js"></script>
    <script src="../js/login.js"></script>
    <script type="text/javascript" src="../js/common.js"></script>
    <script type="text/javascript">
        $(function () {
            $(".nav").accordion({
                accordion: false,
                speed: 500,
                closedSign: '[+]',
                openedSign: '[-]'
            });
        });
    </script>
</head>

<body>
    <div id="header">
        <div class="showResult">
            <ul id="itemList">
                <!--<li>-->
                <!--<p class="text">海威工程建设有限公司</p>-->
                <!--<img class="img" onclick="clearItem($(this))" src="../img/close.png" />-->
                <!--</li>-->
            </ul>
        </div>
    </div>
    <div id="main">
        <div class="demo">
            <ul class="nav" id="selectDepartment">
                <!--<li>-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="fData00001" value="海威工程建设有限公司" />-->
                <!--<p class="text">海威工程建设有限公司</p>-->
                <!--</a>-->
                <!--<ul>-->
                <!--<li>-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="sData00001-00001" value="海威公司机关" />-->
                <!--<p class="text">海威公司机关</p>-->
                <!--</a>-->
                <!--<ul>-->
                <!--<li>-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="tData00001-00001-00001" value="公司领导" />-->
                <!--<p class="text">公司领导</p>-->
                <!--</a>-->
                <!--</li>-->
                <!--<li>-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="tData00001-00001-00002" value="办公室" />-->
                <!--<p class="text">办公室</p>-->
                <!--</a>-->
                <!--</li>-->
                <!--<li>-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="tData00001-00001-00003" value="财务管理部" />-->
                <!--<p class="text">财务管理部</p>-->
                <!--</a>-->
                <!--</li>-->
                <!--<li>-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="tData00001-00001-00004" value="技术质量部" />-->
                <!--<p class="text">技术质量部</p>-->
                <!--</a>-->
                <!--<ul>-->
                <!--<li>-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="foData00001-00001-00001-00001" value="技术中心" />-->
                <!--<p class="text">技术中心</p>-->
                <!--</a>-->
                <!--</li>-->
                <!--</ul>-->
                <!--</li>-->
                <!--</ul>-->
                <!--</li>-->
                <!--<li class="active">-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="sData00001-00002" value="海威机关" />-->
                <!--<p class="text">海威机关</p>-->
                <!--</a>-->
                <!--</li>-->
                <!--<li>-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="sData00001-00003" value="项目部" />-->
                <!--<p class="text">项目部</p>-->
                <!--</a>-->
                <!--<ul>-->
                <!--<li>-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="tData00001-00003-00001" value="塘承项目" />-->
                <!--<p class="text">塘承项目</p>-->
                <!--</a>-->
                <!--</li>-->
                <!--<li>-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="tData00001-00003-00002" value="青兰项目" />-->
                <!--<p class="text">青兰项目</p>-->
                <!--</a>-->
                <!--</li>-->
                <!--<li>-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="tData00001-00003-00003" value="广陕项目" />-->
                <!--<p class="text">广陕项目</p>-->
                <!--</a>-->
                <!--</li>-->
                <!--<li>-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="tData00001-00003-00004" value="山西大同市政项目" />-->
                <!--<p class="text">山西大同市政项目</p>-->
                <!--</a>-->
                <!--<ul>-->
                <!--<li>-->
                <!--<a href="javascript:void(0)">-->
                <!--<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id="foData00001-00003-00004-00001" value="装备产业园区配套排水工程" />-->
                <!--<p class="text">装备产业园区配套排水工程</p>-->
                <!--</a>-->
                <!--</li>-->
                <!--</ul>-->
                <!--</li>-->
                <!--</ul>-->
                <!--</li>-->
                <!--</ul>-->
                <!--</li>-->
            </ul>
        </div>
    </div>
    <div class="footer">
        <a href="javascript:void(0)" title="选择部门" class="btn" onclick="confirm()">确定</a>
        <a href="javascript:void(0)" title="取消选择" class="btn" onclick="cancel()">取消</a>
    </div>

    <script type="application/javascript">


        window.login(function () {



            var listData = [];// 总数据
            var fData = [];// 第一级数据
            var sData = [];// 第二级数据
            var tData = [];// 第三级数据
            var foData = [];// 第四级数据
            var selectDepartmentList = "";// 使用部门（后）
            var selectMemberList = "";// 使用者（后）
            // 页面刷新加载方法
            window.onload = function () {
                selectDepartmentList = noNull(JSON.parse(localStorage.getItem("selectDepartmentList2")));// 使用部门（后）
                selectMemberList = noNull(JSON.parse(localStorage.getItem("selectMemberList2")));// 使用者（后）
                if (selectDepartmentList != "") {
                    var $str = "";
                    $.each(selectDepartmentList, function (i, item) {
                        $str += '<li name=' + item.id + ' value=' + item.name + ' data-orgid=' + item.orgId + ' data-parentid=' + item.parentid + '>',
                            $str += '<p class="text">' + item.name + '</p>',
                            $str += '<img class="img" onclick="clearItem($(this))" name=' + item.id + ' value=' + item.name + ' src="../img/close.png" />',
                            $str += '</li>'
                    });
                    $("#itemList").append($str);
                }
                queryDepartment();// 选择部门查询
            };

            // 选择部门新增
            function queryDepartment() {
                $.ajax({
                    url: API + 'getDepartment',
                    type: 'POST',
                    dataType: 'json',
                    data: JSON.stringify({}),
                    timeout: timeout,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json; charset=utf-8',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function (rel) {
                        if (rel.code === '3003' || rel.code === '3004') {
                            //重新获取code登录
                            window.reset();
                        }

                        if (rel.success == true) {
                            listData = noNull(rel.data);// 详情数据
                            loopList();
                            if ($(".showResult").height() > 132 && 365 > $(".showResult").height()) {
                                $("#main").css("margin-top", '260px');
                            } else if ($(".showResult").height() >= 365) {
                                $("#main").css("margin-top", '400px');
                            } else {
                                $("#main").css("margin-top", '170px');
                            }
                        }
                    },
                    error: function (err) {
                        console.log(err);
                    }
                })
            }

            // 处理数据 并循环
            function loopList() {
                // 获取一级列表数据
                if (listData != "") {
                    for (var i = 0, j = 0; i <= listData.length - 1; i++) {
                        if (noNull(listData[i].parentid) == "") {
                            fData[j] = {
                                id: listData[i].id,
                                name: listData[i].name,
                                order: listData[i].order,
                                orgId: listData[i].orgId,
                                parentid: listData[i].parentid
                            }
                            j++;
                        }
                    }
                }
                // 循环插入一级列表 并 获取二级列表数据
                if (noNull(fData) != "") {
                    var selectState = false;// 为true时则显示有下一级，false则没有
                    var $str = "";
                    $("#selectDepartment li").remove();
                    // 循环插入 一级列表
                    $.each(fData, function (i, item) {
                        $str += '<li>',
                            $str += '<a href="javascript:void(0)">',
                            $str += '<input class="checkbox" type="checkbox" onclick="checkBox($(this))" id=' + item.id + ' value=' + item.name + ' data-orgid=' + item.orgId + ' data-pid="' + item.parentid + '" />',
                            $str += '<p class="text">' + item.name + '</p>',
                            $str += '</a>',
                            $str += '<ul id="fData' + item.id + '">',
                            $str += '</ul>',
                            $str += '</li>'
                    });
                    $("#selectDepartment").append($str);
                    // 获取二级列表数据
                    for (var i = 0, j = 0; i <= fData.length - 1; i++) {
                        for (var k = 0; k <= listData.length - 1; k++) {
                            if (noNull(fData[i].id) == noNull(listData[k].parentid)) {
                                selectState = true;// 为true时则显示有下一级，false则没有
                                sData[j] = {
                                    id: listData[k].id,
                                    name: listData[k].name,
                                    order: listData[k].order,
                                    orgId: listData[k].orgId,
                                    parentid: listData[k].parentid
                                }
                                j++;
                            }
                        }
                        if (selectState == false) {
                            $("#fData" + fData[i].id).remove();// 删除一级展开项
                        }
                    }
                }
                // 循环插入二级列表 并 获取三级列表数据
                if (noNull(sData) != "") {
                    var selectState = false;// 为true时则显示有下一级，false则没有
                    // 循环插入 二级列表
                    $.each(sData, function (i, item) {
                        var $str = "";
                        $str += '<li>',
                            $str += '<a href="javascript:void(0)">',
                            $str += '<input class="checkbox" type="checkbox" id=' + item.id + ' value=' + item.name + ' data-orgid=' + item.orgId + ' data-pid=' + item.parentid + ' onclick="checkBox($(this))" />',
                            $str += '<p class="text">' + item.name + '</p>',
                            $str += '</a>',
                            $str += '<ul id="sData' + item.id + '">',
                            $str += '</ul>',
                            $str += '</li>'
                        $.each(fData, function (j, param) {
                            if (noNull(param.id) == noNull(item.parentid)) {
                                $("#fData" + param.id).append($str);// 传入一级列表
                            }
                        })
                    });
                    // 获取三级列表数据
                    for (var i = 0, j = 0; i <= sData.length - 1; i++) {
                        for (var k = 0; k <= listData.length - 1; k++) {
                            if (noNull(sData[i].id) == noNull(listData[k].parentid)) {
                                selectState = true;// 为true时则显示有下一级，false则没有
                                tData[j] = {
                                    id: listData[k].id,
                                    name: listData[k].name,
                                    order: listData[k].order,
                                    orgId: listData[k].orgId,
                                    parentid: listData[k].parentid
                                }
                                j++;
                            }
                        }
                        if (selectState == false) {
                            $("#sData" + sData[i].id).remove();// 删除二级展开项
                        }
                        selectState = false;// 为true时则显示有下一级，false则没有
                    }
                }
                // 循环插入三级列表 并 获取四级列表数据
                if (noNull(tData) != "") {
                    var selectState = false;// 为true时则显示有下一级，false则没有
                    // 循环插入 三级列表
                    $.each(tData, function (i, item) {
                        var $str = "";
                        $str += '<li>',
                            $str += '<a href="javascript:void(0)">',
                            $str += '<input class="checkbox" type="checkbox" id=' + item.id + ' value=' + item.name + ' data-orgid=' + item.orgId + ' data-pid=' + item.parentid + ' onclick="checkBox($(this))" />',
                            $str += '<p class="text">' + item.name + '</p>',
                            $str += '</a>',
                            $str += '<ul id="tData' + item.id + '">',
                            $str += '</ul>',
                            $str += '</li>'
                        $.each(sData, function (j, param) {
                            if (noNull(param.id) == noNull(item.parentid)) {
                                $("#sData" + param.id).append($str);// 传入二级列表
                            }
                        })
                    });
                    // 获取四级列表数据
                    for (var i = 0, j = 0; i <= tData.length - 1; i++) {
                        for (var k = 0; k <= listData.length - 1; k++) {
                            if (noNull(tData[i].id) == noNull(listData[k].parentid)) {
                                selectState = true;// 为true时则显示有下一级，false则没有
                                foData[j] = {
                                    id: listData[k].id,
                                    name: listData[k].name,
                                    order: listData[k].order,
                                    orgId: listData[k].orgId,
                                    parentid: listData[k].parentid
                                }
                                j++;
                            }
                        }
                        if (selectState == false) {
                            $("#tData" + tData[i].id).remove();// 删除三级展开项
                        }
                        selectState = false;// 为true时则显示有下一级，false则没有
                    }
                }
                // 循环插入四级列表(四级为最后一级无展开项)
                if (noNull(foData) != "") {
                    // 循环插入 四级列表
                    $.each(foData, function (i, item) {
                        var $str = "";
                        $str += '<li>',
                            $str += '<a href="javascript:void(0)">',
                            $str += '<input class="checkbox" type="checkbox" id=' + item.id + ' value=' + item.name + ' data-orgid=' + item.orgId + ' data-pid=' + item.parentid + ' onclick="checkBox($(this))" />',
                            $str += '<p class="text">' + item.name + '</p>',
                            $str += '</a>',
                            $str += '</li>'
                        $.each(tData, function (j, param) {
                            if (noNull(param.id) == noNull(item.parentid)) {
                                $("#tData" + param.id).append($str);// 传入三级列表
                            }
                        })
                    });
                }
                $(".nav").accordion({
                    accordion: false,
                    speed: 500,
                    closedSign: '[+]',
                    openedSign: '[-]'
                });
                // 将被选择项 勾选
                if (selectDepartmentList != "") {
                    $.each(selectDepartmentList, function (i, item) {
                        $("#" + item.id).get(0).checked = true;
                    });
                }
            }

            // 清除选中项
            function clearItem(dom) {
                var departmentId = dom[0].name;
                $("#" + departmentId).get(0).checked = !($("#" + departmentId).is(':checked'));
                dom.parent().remove();//删除可见范围中选中项

                if ($(".showResult").height() > 132 && 365 > $(".showResult").height()) {
                    $("#main").css("margin-top", '260px');
                } else if ($(".showResult").height() >= 365) {
                    $("#main").css("margin-top", '400px');
                } else {
                    $("#main").css("margin-top", '170px');
                }
            }

            // 点击触发CheckBox
            function checkBox(dom) {
                var departmentId = dom.attr("id");// 部门ID
                var departmentName = dom.attr("value");// 部门名称
                var orgid = dom.attr("data-orgid");// orgId
                var pId = dom.attr("data-pid");// 部门parentId
                if (dom[0].checked == true) {
                    var $str = "";
                    $str += '<li name=' + departmentId + ' value=' + departmentName + ' data-orgid=' + orgid + ' data-pid=' + pId + '>',
                        $str += '<p class="text">' + departmentName + '</p>',
                        $str += '<img class="img" onclick="clearItem($(this))" name=' + departmentId + ' value=' + departmentName + ' src="../img/close.png" />',
                        $str += '</li>'
                    $("#itemList").append($str);
                } else {
                    $("#itemList li[name=" + departmentId + "]").remove();
                }

                if ($(".showResult").height() > 132 && 365 > $(".showResult").height()) {
                    $("#main").css("margin-top", '260px')
                } else if ($(".showResult").height() >= 365) {
                    $("#main").css("margin-top", '400px')
                } else {
                    $("#main").css("margin-top", '170px');
                }
            }

            // 确定
            function confirm() {
                var checkArr = [];// 筛选出的部门列表
                var selectMemberList = noNull(JSON.parse(localStorage.getItem("selectMemberList2")));// 使用者（后）
                $("#itemList li").each(function (i, item) {
                    checkArr[i] = {
                        id: noNull(item.attributes[0].value),
                        name: noNull(item.attributes[1].value),
                        orgId: noNull(item.attributes[2].value),
                        parentid: noNull(item.attributes[3].value)
                    }
                });
                localStorage.setItem("selectDepartmentList", JSON.stringify(checkArr));// 将筛选出的 部门列表数据 传入 临时储存
                localStorage.setItem("selectMemberList", JSON.stringify(selectMemberList));// 将筛选出的 成员列表数据 传入 临时储存
                localStorage.setItem("refreshState", false);// 为true时，则刷新数据，false则不刷新
                window.history.back();
            }

            // 取消
            function cancel() {
                localStorage.setItem("selectDepartmentList", JSON.stringify(selectDepartmentList));// 将筛选出的 部门列表数据 传入 临时储存
                localStorage.setItem("selectMemberList", JSON.stringify(selectMemberList));// 将筛选出的 成员列表数据 传入 临时储存
                localStorage.setItem("refreshState", false);// 为true时，则刷新数据，false则不刷新
                window.history.back();
            }





        })





    </script>
</body>

</html>